<html>
<head>
  <meta name = "viewport" content = "width=device-width, initial-scale=0.7, maximum-scale=0.7, user-scalable=0"/>
  <meta name = "mobile-web-app-capable" content = "yes">
  <meta name = "theme-color" content="#202080">
  <!-- TODO: Use new scheme for homescreen adding -->
  <link href = "css/bootstrap.css" rel = "stylesheet">
  <link href = "css/ripples.min.css" rel = "stylesheet">
  <link href = "css/material-wfont.min.css" rel = "stylesheet">
  <title>WebStaples</title>
  <style>
      html, body {
          max-width: 100%;
          overflow-x: hidden;
          /*background-color: red;*/
      }

      .menu ul {
          list-style-type: none;
          padding: 0;
      }

      .menu li {
          background-color: white;
          padding: 0.65em 0 0.65em 1em;
          margin: 0.6em;
          cursor: hand;
          position: relative;
          -webkit-transform: translateX(0);
          -moz-transform: translateX(0);
          transform: translateX(0);
          -webkit-transition: all .6s cubic-bezier(.55, 0, .1, 1);
          -moz-transition: all .6s cubic-bezier(.55, 0, .1, 1);
          transition: all .6s cubic-bezier(.55, 0, .1, 1);
      }

      .menu li.active {
          -webkit-transform: translateX(42px);
          -moz-transform: translateX(42px);
          transform: translateX(42px);

          -webkit-transition: all .6s cubic-bezier(.55, 0, .1, 1) 1s;
          -moz-transition: all .6s cubic-bezier(.55, 0, .1, 1) 1s;
          transition: all .6s cubic-bezier(.55, 0, .1, 1) 1.1s;
      }

      .status-band {
          position: absolute;
          left: 0;
          top: 0;
          width: 10px;
          height: 100%;
      }

      @media (min-width: 768px) {
          .pages {
              padding: 0 0 0 1em;
          }
      }

      @media (max-width: 767px) {
          .pages {
              padding: 0 0 0 0;
          }
      }

      .page {
          margin: 0;
          z-index: 1;
          overflow: auto;
          position: relative;
          height: 43.6em;
          padding-bottom: 1em;
          -webkit-transform: translateX(300%);
          -moz-transform: translateX(300%);
          transform: translateX(300%);
          -webkit-transition: -webkit-transform .8s cubic-bezier(.55, 0, .1, 1);
          -moz-transition: -moz-transform .8s cubic-bezier(.55, 0, .1, 1);
          transition: transform .8s cubic-bezier(.55, 0, .1, 1);
      }

      .page.active {
          -webkit-transform: translateX(0);
          -moz-transform: translateX(0);
          transform: translateX(0);
          -webkit-transition: -webkit-transform .8s cubic-bezier(.55, 0, .1, 1);
          -moz-transition: -moz-transform .8s cubic-bezier(.55, 0, .1, 1);
          transition: transform .8s cubic-bezier(.55, 0, .1, 1);
      }

      .notes {
          font-size: 24px;
      }

      .timer-block {
          height: 10.5em;
      }

      #timerHeader {
          margin-top: 0;
          position: absolute;
          -webkit-transform: translateX(0);
          -moz-transform: translateX(0);
          transform: translateX(0);
      }

      #timerHeader.active {
          -webkit-transform: translateX(400%);
          -moz-transform: translateX(400%);
          transform: translateX(400%);
          -webkit-transition: -webkit-transform .8s ease-in;
          -moz-transition: -moz-transform .8s ease-in;
          transition: transform .8s ease-in;
      }

      h1 {
          margin-top: 0;
      }

      .staples-blue {
           color: white;
           background-color: #202080 !important;
      }

      .staples-blue:hover {
          color: white;
      }

      #btn-settings {
          position: absolute;
          left:-30px;
          top:75px;
      }

      .staples-blue h1, .staples-blue h2 {
          color: white !important;
      }

      var {
          display: none;
      }
  </style>
</head>
<body>
<!-- Your site -->
<br/>

<div class = "container">
  <div class = "row well staples-blue" style="padding-top: 1.7em; height:8em">
      <h1 class = "" style="position: absolute;">WebStaples<span class="hidden-xs">: Web Port of MyStaples</span></h1><h1 class="text-right" id="clockTime"></h1>
      <hr />
  </div>
  <div class = "row">
    <div class = "menu col-sm-4 well">
      <a class="btn btn-fab staples-blue" data-toggle="modal" data-target="#settings-dialog" id="btn-settings">
        <span class="mdi-action-settings"></span>
      </a>
      <ul>
        <li class = "active withripple shadow-z-3" data-target = "#announcements">
          <div class = "status-band btn-success"></div>
          Announcements</li>
      </ul>
        <hr   />
        <h2 class="panel-heading" style="margin-top: 0">Schedule</h2>
      <ul>
        <% @schedule_len.times do |i| %>
        <li class = "withripple shadow-z-2" data-target = "#class<%=i+1%>">
          <div class = "status-band"></div>
          <span>Class <%=i+1%></span></li>
        <% end %>
      </ul>
    </div>
    <div class = "pages col-sm-8">
      <div class = "well page active" id = "announcements">
        <h1 class="modal-header">Today's Announcements</h1>
        <span id="announcementZone">
            <div class="row">
              <div class="col-lg-6">
              </div>
            </div>
        </span>
      </div>
      <% @schedule_len.times do |i| %>
      <div class = "well page" id = "class<%=i+1%>" style = "display: none;">
        <h1 class="modal-header">Class <%=i+1%></h1>
        <textarea class = "form-control floating-label notes" placeholder = "Homework" rows = "5"></textarea>
      </div>
      <% end %>
    </div>
  </div>
  <div class = "row well timer-block staples-blue">
    <h1 id = "timerHeader">Welcome, Guest!</h1>

    <div style = "margin-top: 3em;">
                <span style = "margin-left: -1.5em">
                    <span id = "currentTime" style = "color: lightgrey;">0:00</span>
                </span>

      <div class = "progress progress-striped active" style = "margin-top: .5em;">
        <div class = "progress-bar progress-bar-material-blue" id = "classProgress" style = "width: 0;"></div>
      </div>
    </div>
    <table style = "width:100%;">
      <tr>
        <td id = "startTime" style = "color: lightgrey;">0:00</td>
        <td class = "text-right" id = "endTime" style = "color: lightgrey;">0:00</td>
      </tr>
    </table>
  </div>
</div>

<div id="settings-dialog" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h4 class="modal-title">Settings</h4>
      </div>
      <form method="post" action="/">
          <div class="modal-body">
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 1 Class" name="per1" id="conf_per1"><br />
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 2 Class" name="per2" id="conf_per2"><br />
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 3 Class" name="per3" id="conf_per3"><br />
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 4 Class" name="per4" id="conf_per4"><br />
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 5 Class" name="per5" id="conf_per5"><br />
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 6 Class" name="per6" id="conf_per6"><br />
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 7 Class" name="per7" id="conf_per7"><br />
            <input type="text" class="form-control floating-label config-input-class" placeholder="Period 8 Class" name="per8" id="conf_per8">
          </div>
          <div class="modal-footer">
            <input value="Apply" name="config_per" type="submit" class="btn btn-primary btn-flat" style="margin:0 0 0 0;"><input value="Cancel" name="cancel" type="reset" class="btn btn-primary btn-flat" data-dismiss="modal" style="margin:0;">
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Your site ends -->
<script src = "//code.jquery.com/jquery-1.10.2.min.js"></script>
<script src = "//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

<script src = "js/ripples.min.js"></script>
<script src = "js/material.min.js"></script>

<!-- Begin variable transfer from Ruby -->
<var id="userData">{
    "1": "<%= session[:per1] %>",
    "2": "<%= session[:per2] %>",
    "3": "<%= session[:per3] %>",
    "4": "<%= session[:per4] %>",
    "5": "<%= session[:per5] %>",
    "6": "<%= session[:per6] %>",
    "7": "<%= session[:per7] %>",
    "8": "<%= session[:per8] %>"
  }</var>
<!-- End variables -->

<script>
    var serverTimeObj = {};
    var timeOffset = 0;
    var now = null;
    var then = null;
    var serverSecs = 0;
    var localSecs = 0;
    $.getJSON('/api/time', null, function(data) {
        serverTimeObj = data;
        serverSecs = (+serverTimeObj.hours * 60 + serverTimeObj.mins) * 60 + serverTimeObj.secs;
        now = new Date();
        then = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        localSecs = ((now.getTime() - then.getTime()) / 1000);
        timeOffset = serverSecs-localSecs;

        timeOffset-=45; // Server time is ~45 seconds fast compared to clocks in building

        console.log(timeOffset);
    });

    function t(h, m) {
        return (h * 60 + m) * 60;
    }

    var schedule = {};

    $.getJSON('/api/schedule?date=today', null, function(data){
        schedule = data;
        schedule.push({
            name: 'Contact coder if you see this',
            start_seconds: -5,
            end_seconds: -5
        });
    });


    var user_schedule = {};

    $.getJSON('/api/user/schedule', null, function(data){
        user_schedule = data;
    });

    var percentComplete = 0;
    var currentClass = null;

    var announcements = {};
    $.getJSON('/api/announcements/today', null, function(data){
        announcements = data;
    });

    setTimeout(function (){
        $(document).ready(function () {
            $.material.init();

            var ancTxt = "\n";

            for(var curAnc = 0; curAnc < announcements.length; curAnc += 2) {
                ancTxt+='<div class="row">\n';
                if(curAnc != announcements.length-1) {
                    ancTxt += '<div class="col-md-6">\n' +
                                '<h3>'+announcements[curAnc].title+'</h3>\n' +
                                '<p>'+announcements[curAnc].body+'</p>\n' +
                              '</div>\n';
                    ancTxt += '<div class="col-md-6">\n' +
                                '<h3>'+announcements[curAnc+1].title+'</h3>\n' +
                                '<p>'+announcements[curAnc+1].body+'</p>\n' +
                              '</div>\n';
                } else {
                    ancTxt += '<div class="col-md-12">\n' +
                                '<h3>'+announcements[curAnc].title+'</h3>\n' +
                                '<p>'+announcements[curAnc].body+'</p>\n' +
                              '</div>\n';
                }
                ancTxt+='</div>\n';
            }


            $('#announcementZone').html(ancTxt);

            var i = 0;
            $('.page').not("#announcements").each(function () {
                var cls = schedule[i];
                $(this).find('h1').first().text(cls.name + ": " + user_schedule[cls.name]);
                i++;
            });
            i = 0;
            $('.menu li span').each(function () {
                var cls = schedule[i];
                if( (cls.name == "1" || cls.name == "2" || cls.name == "3" || cls.name == "4" || cls.name == "5" || cls.name == "6" || cls.name == "7" || cls.name == "8") && user_schedule.code == 0) {
                    $(this).text(cls.name + ": " + user_schedule[cls.name]);
                } else {
                    $(this).text(cls.name);
                    if(user_schedule.code != 100) {
                        console.log("Could not load your classes, error code " + user_schedule.code + " with data of " + user_schedule.err_str);
                    }
                }
                i++;
            });
            i = 1;
            $('.config-input-class').each(function() {
                $(this).val(user_schedule[String(i)]);
                i++;
            });
            /* Updates Class Header */ setInterval(function () {
                var timerHeader = $("#timerHeader");
                if (currentClass != null ? currentClass.name + ": " + user_schedule[currentClass.name] != timerHeader.text() : timerHeader.text() != "No School") {
                    timerHeader.addClass("active").fadeOut(800, function () {
                        $(this).removeClass("active");
                        if (currentClass != null)
                            timerHeader.text(currentClass.name + ": " + user_schedule[currentClass.name]);
                        else
                            timerHeader.text("No School");
                        setTimeout(function () {
                            $(this).fadeIn(800);
                        }.bind(this), 100);
                    });
                }
            }, 4000);
            /* Updates time and current class */ setInterval(function () {
                now = new Date();
                then = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                var secsSinceMidnight = ((now.getTime() - then.getTime()) / 1000) + timeOffset;

                for (var classId = 0; classId < schedule.length - 1; classId++) {
                    if (schedule[classId].start_seconds < secsSinceMidnight && secsSinceMidnight < schedule[classId].end_seconds) {
                        currentClass = schedule[classId];
                        //console.log(classId);
                        break;
                    } else if (schedule[classId].end_seconds < secsSinceMidnight && secsSinceMidnight < schedule[classId + 1].start_seconds) {
                        currentClass = {
                            name: "Passing Time",
                            start_seconds: schedule[classId].end_seconds,
                            end_seconds: schedule[classId + 1].start_seconds
                        };
                        $('.menu li[data-target="#class' + (classId + 1) + '"]').addClass('btn-material-grey');
                        break;
                    } else {
                        $('.menu li[data-target="#class' + (classId + 1) + '"]').addClass('btn-material-grey');
                    }
                }

                hours = Math.floor(secsSinceMidnight / 60 / 60);
                totalMins = Math.floor(secsSinceMidnight / 60);
                min = totalMins == 0 ? "00" : ((totalMins % 60 < 10) ? "0" + totalMins % 60 : totalMins % 60);
                $("#clockTime").text((hours > 12 ? hours - 12 : hours) + ":" + min + (hours >= 12 ? " PM" : " AM"));
                if (currentClass != null) {
                    $(".menu li").each(function () {
                        if ($(this).data('target') != '#class' + (classId + 1) ||
                                currentClass.name == "Passing Time") {
                            $(this).removeClass('staples-blue');
                            return;
                        }
                        $(this).addClass('staples-blue');
                    });
                    percentComplete = Math.round((secsSinceMidnight - currentClass.start_seconds) / (currentClass.end_seconds - currentClass.start_seconds) * 10000) / 100;

                    var timeThroughCurrentClass = currentClass.end_seconds - secsSinceMidnight;
                    var totalMins = Math.floor(timeThroughCurrentClass / 60);
                    var min = totalMins == 0 ? "00" : ((totalMins < 10) ? "0" + totalMins : totalMins);
                    var sec = Math.floor(timeThroughCurrentClass % 60);
                    sec = sec == 0 ? "00" : ((sec < 10) ? "0" + sec : sec);

                    $("#currentTime").text("-" + min + ":" + sec).css("margin-left", percentComplete + "%").css("margin-left", "-=1.5em");

                    var hours = Math.floor(currentClass.start_seconds / 60 / 60);
                    totalMins = Math.floor(currentClass.start_seconds / 60);
                    min = totalMins == 0 ? "00" : ((totalMins % 60 < 10) ? "0" + totalMins % 60 : totalMins % 60);
                    $("#startTime").text((hours > 12 ? hours - 12 : hours) + ":" + min + (hours >= 12 ? " PM" : " AM"));

                    hours = Math.floor(currentClass.end_seconds / 60 / 60);
                    totalMins = Math.floor(currentClass.end_seconds / 60);
                    min = totalMins == 0 ? "00" : ((totalMins % 60 < 10) ? "0" + totalMins % 60 : totalMins % 60);
                    $("#endTime").text((hours > 12 ? hours - 12 : hours) + ":" + min + (hours >= 12 ? " PM" : " AM"));
                }
            }, 20);
            /* Sets the progress of the timer bar */ setInterval(function () {
                $("#classProgress").css("width", percentComplete + "%")
            }, 200);
        });
    }, 1000);
    $(".menu li").click(function () {
        if ($(this).is('.active')) return;
        $(".menu li").removeClass("active").removeClass("shadow-z-3").addClass("shadow-z-2").find('.status-band').removeClass('btn-success');
        $(this).addClass("active").addClass("shadow-z-3").removeClass("shadow-z-2").find('.status-band').addClass('btn-success');

        var target = $($(this).data('target'));

        var oldPage = $('.page.active');
        oldPage.removeClass('active');

        setTimeout(function () {
            oldPage.fadeOut(0);
            target.fadeIn(0);
            target.addClass('active');
        }, 400);
    });
</script>
</body>
</html>
